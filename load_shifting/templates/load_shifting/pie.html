<!DOCTYPE html>
<title>Updating pie chart d3 v4</title>
<meta charset="utf-8">
<style>

  body {
      font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
  }

  text {
      font: 32px sans-serif;
      font-weight: bold;
      fill: black;
  }

  .clockTime {
      text-align: center;
  }
  h2 {
      text-align: center;
  }

  form {
    position: absolute;
    right: 10px;
    top: 10px;
  }

  input {
      margin: 0 7px;
  }

  .column {
      float: left;
      width: 960px;
  }
  
  /* Clear floats after the columns */
  .row:after {
      content: "";
      display: table;
      clear: both;
  }

</style>
<form></form>
 <div class="row">
  <div class="column" id="column-1"></div>
  <div class="column" id="column-2"></div>
 </div>
 <div class="row">
  <div class="column" id="column-3"></div>
  <div class="column" id="column-4"></div>
</div> 
<script src="https://d3js.org/d3.v4.min.js"></script>
<script>

  function color(d) {
      return {
	  "Solar": "orange",
	  "Wind": "#17becf",
	  "Hydro": "blue",
	  "Nuclear": "grey",
	  "Natural gas": "red",
	  "Coal": "black",
	  "Petroleum": "brown",
	  "Other": "green"
      }[d];
  }

  function add_pie_chart_to_page(column_div_id, param_ba, param_year) {
      var myDuration = 600;
      var firstTime = true;

      var width = 960,
	  height = 500,
	  radius = Math.min(width, height) / 2;

      /*var width = 960,
	height = 500,
	radius = Math.min(width, height) / 2;*/
      // var color = d3.scaleOrdinal(d3.schemeCategory20);
      
      
      var pie = d3.pie()
	  .value(function(d) { return d.mwh; })
	  .sort(null);
      
      var arc = d3.arc()
	  .innerRadius(radius - 100)
	  .outerRadius(radius - 20);

      d3.select(column_div_id).append("h2").text(param_ba + " " + param_year);
      
      var svg = d3.select(column_div_id).append("svg")
	  .attr("width", width)
	  .attr("height", height)
	  .append("g")
	  .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");
      
      
      var url = "/load_shifting/energy_mix.json?ba=" + param_ba + "&year=" + param_year;
      console.log("Requesting URL " + url);
      
      d3.json(url, function(data) {
	  	  
	  function change_chart_to_hour(data_series_for_hour) {
	      var path = svg.selectAll("path");
	      var data0 = path.data(),
		  data1 = pie(data_series_for_hour.values);
	      
	      path = path.data(data1, key);
	      
	      path.transition()
		  .duration(myDuration)
		  .attrTween("d", arcTween)
	      
	      
	      path.enter()
		  .append("path")
		  .each(function(d, i) {
		      var narc = findNeighborArc(i, data0, data1, key) ;
		      if(narc) {          
			  this._current = narc;
			  this._previous = narc;
		      } else {          
			  this._current = d;
		      }
		  }) 
		  .attr("fill", function(d,i) { 
		      return color(d.data.fuel)
		  })
		  .transition()
		  .duration(myDuration)
		  .attrTween("d", arcTween)
	      
	      
	      path.exit()
		  .transition()
		  .duration(myDuration)
		  .attrTween("d", function(d, index) {
		      
		      var currentIndex = this._previous.data.fuel;
		      var i = d3.interpolateObject(d,this._previous);
		      return function(t) {
			  return arc(i(t))
		      }
		      
		  })
		  .remove()
	      firstTime = false;
	      
	  }
	  
	  
	  var textData = [{"hour": ""}];
	  
	  var myText = svg.append('text')
	      .data(textData)
	      .attr('x', -25)
	      .attr('y', 0)
	      .attr('fill', '#000')
	      .classed('clockTime', true)
	      .text(function(d) { return d.hour })
	  
	  function change_label_to_hour( new_hour ) {
	      var twelve_hour_clock_time = new_hour%12;
	      if (twelve_hour_clock_time == 0) {
		  twelve_hour_clock_time = 12;
	      }
	      if (new_hour < 12) {
		  twelve_hour_clock_time = twelve_hour_clock_time + " am";
	      } else {
		  twelve_hour_clock_time = twelve_hour_clock_time + " pm";
	      }
	      textData = [{"hour": twelve_hour_clock_time}]
	      
	      myText.data(textData)
		  .transition()
		  .duration(50)
		  .style("opacity", 0)
		  .transition().duration(50)
		  .style("opacity", 1)
		  .text(function(d) { return d.hour });
	  }
	  
	  
	  var current_hour = 0;
	  const t = d3.interval((elapsed) => {
	      current_hour = (current_hour + 1) % 24;
	      
	      var hour_series = data["data_series"].find((element) => element["key"] == "Hour = " + current_hour);
	      //console.log(current_hour);
	      change_chart_to_hour(hour_series);
	      change_label_to_hour(current_hour);
	  }, 1000, 0);
	  
      });
        function key(d) {
    return d.data.fuel;
  }

  function type(d) {
    d.mwh = +d.mwh;
    return d;
  }

  function findNeighborArc(i, data0, data1, key) {
    var d;
    if(d = findPreceding(i, data0, data1, key)) {

      var obj = cloneObj(d)
      obj.startAngle = d.endAngle;
      return obj;

    } else if(d = findFollowing(i, data0, data1, key)) {

      var obj = cloneObj(d)
      obj.endAngle = d.startAngle;
      return obj;

    }

    return null


  }

// Find the element in data0 that joins the highest preceding element in data1.
function findPreceding(i, data0, data1, key) {
  var m = data0.length;
  while (--i >= 0) {
    var k = key(data1[i]);
    for (var j = 0; j < m; ++j) {
      if (key(data0[j]) === k) return data0[j];
    }
  }
}

// Find the element in data0 that joins the lowest following element in data1.
function findFollowing(i, data0, data1, key) {
  var n = data1.length, m = data0.length;
  while (++i < n) {
    var k = key(data1[i]);
    for (var j = 0; j < m; ++j) {
      if (key(data0[j]) === k) return data0[j];
    }
  }
}

function arcTween(d) {

  var i = d3.interpolate(this._current, d);

  this._current = i(0);

  return function(t) {
    return arc(i(t))
  }

}


function cloneObj(obj) {
  var o = {};
  for(var i in obj) {
    o[i] = obj[i];
  }
  return o;
}
  }

  add_pie_chart_to_page("#column-1", "CISO", 2019);
  add_pie_chart_to_page("#column-2", "CISO", 2024);
  add_pie_chart_to_page("#column-3", "ERCO", 2019);
  add_pie_chart_to_page("#column-4", "ERCO", 2024);

</script>


